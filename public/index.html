<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<title>Generator Godzin Emerlog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<style>
:root{--ink:#111;--muted:#555;--grid:#000;--off-bg:#ffcccc;--off-ink:#a00;--thead-bg:#fff;--paper:#fff}
html,body{background:#f5f5f7;color:var(--ink)}
.container{max-width:1040px}
header{background:#fff;border-bottom:1px solid #e5e7eb}
.brand{font-weight:700}
.card{border:1px solid #e5e7eb;border-radius:12px}
.card-header{background:#fff;border-bottom:1px solid #e5e7eb;font-weight:600}

/* tabela */
.sheet-wrap{background:var(--paper);border:1px solid var(--grid);border-radius:10px;overflow:hidden}
.sheet-head{padding:16px 18px 8px 18px;border-bottom:1px solid var(--grid)}
.sheet-head .mname{font-size:24px;font-weight:800;margin:0}
.sheet-head .person{font-size:18px;font-weight:700;margin:2px 0 0}
.sheet-head .ctype{font-size:12px;color:var(--muted);margin:0}
.table-times{width:100%;border-collapse:collapse;table-layout:fixed;background:var(--paper)}
.table-times th,.table-times td{border:1px solid var(--grid);padding:8px 10px;text-align:center;vertical-align:middle;background:#fff;font-size:14px}
.table-times thead th{background:var(--thead-bg);font-weight:700}
.table-times .col-day{width:54px}
.table-times .col-date{text-align:left}
.table-times .col-start,.table-times .col-end{width:100px}
.table-times .col-hours{width:90px}
.table-times .col-sign{width:140px}
.table-times .col-leave{width:110px}
.mono{font-variant-numeric:tabular-nums}
.table-times tr.off td{background:var(--off-bg);color:var(--off-ink);font-weight:700}
.table-times tfoot td{font-weight:800;background:#fff}
@media print{body{background:#fff}.card,.sheet-wrap{box-shadow:none}*{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
</style>
</head>
<body>
<header>
  <div class="container py-3 d-flex justify-content-between align-items-center">
    <div class="brand h5 m-0"><i class="fas fa-clock me-2 text-primary"></i>Generator Godzin Emerlog</div>
  </div>
</header>

<main class="container py-4">
  <section class="card mb-4">
    <div class="card-header py-3 px-4">Parametry</div>
    <div class="card-body p-4">
      <form id="generatorForm" novalidate>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label" for="name">Imię i nazwisko *</label>
            <input class="form-control" id="name" required>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="month">Miesiąc *</label>
            <select class="form-select" id="month" required>
              <option value="">Wybierz…</option>
              <option value="1">Styczeń</option><option value="2">Luty</option><option value="3">Marzec</option>
              <option value="4">Kwiecień</option><option value="5">Maj</option><option value="6">Czerwiec</option>
              <option value="7">Lipiec</option><option value="8">Sierpień</option><option value="9">Wrzesień</option>
              <option value="10">Październik</option><option value="11">Listopad</option><option value="12">Grudzień</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label" for="year">Rok *</label>
            <input class="form-control" type="number" id="year" min="2000" value="2025" required>
          </div>
          <div class="col-md-3">
            <label class="form-label d-block">Rodzaj umowy</label>
            <div class="form-check"><input class="form-check-input" type="radio" name="contractType" value="zlecenie" checked><label class="form-check-label">Umowa zlecenie</label></div>
            <div class="form-check"><input class="form-check-input" type="radio" name="contractType" value="praca"><label class="form-check-label">Umowa o pracę</label></div>
            <div class="form-check"><input class="form-check-input" type="radio" name="contractType" value="praca3/4"><label class="form-check-label">Umowa o pracę (3/4)</label></div>
          </div>
        </div>

        <hr class="my-4">

        <div class="row g-3">
          <div class="col-md-5" id="hoursGroup">
            <label class="form-label" for="hours">Łączna liczba godzin (zlecenie) *</label>
            <input class="form-control" type="number" id="hours" min="30" step="1">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="randomHolidays">
              <label class="form-check-label" for="randomHolidays">Losowe dni wolne (18–25%)</label>
            </div>
          </div>

          <div class="col-md-7">
            <label class="form-label">Własne dni wolne</label>
            <div class="row g-2">
              <div class="col-md-6"><input class="form-control" type="date" id="holidayPicker"></div>
              <div class="col-md-4">
                <select class="form-select" id="holidayTypeSelect">
                  <option value="-">Wolne</option>
                  <option value="Święto">Święto (ręcznie)</option>
                </select>
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary" type="button" id="addHoliday"><i class="fa fa-plus"></i></button>
              </div>
            </div>
            <ul class="small mt-2" id="holidaysList"></ul>
          </div>
        </div>

        <div class="mt-4 d-flex gap-2">
          <button class="btn btn-primary" type="submit"><i class="fa fa-table me-1"></i>Generuj tabelę</button>
          <button class="btn btn-success" type="button" id="generatePDF" disabled><i class="fa-regular fa-file-pdf me-1"></i>Pobierz PDF</button>
          <button class="btn btn-info text-white" type="button" id="sendMail" disabled><i class="fa fa-envelope me-1"></i>Wyślij na maila</button>
        </div>
      </form>
    </div>
  </section>

  <section class="sheet-wrap" id="resultWrap" style="display:none;">
    <div class="sheet-head">
      <h2 class="mname" id="mname"></h2>
      <p class="person" id="pname"></p>
      <p class="ctype" id="ctype"></p>
    </div>
    <div id="output"></div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(()=>{"use strict";
/* parametry czasu */
const MIN_START=6, MAX_END=20;
const MIN_H=4, MAX_H=16; // zlecenie
const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
let customHolidays=[];

/* utils */
const ri=(a,b)=>{a=Math.ceil(a);b=Math.floor(b);return Math.floor(Math.random()*(b-a+1))+a;}
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const toISO=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const isWeekend=d=>{const w=d.getDay();return w===0||w===6;}
function easterSunday(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),mo=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,mo-1,day);}
function plHolidays(year){const fixed=["01-01","01-06","05-01","05-03","08-15","11-01","11-11","12-25","12-26"].map(md=>`${year}-${md}`);const e=easterSunday(year);const iso=x=>toISO(new Date(e.getFullYear(),e.getMonth(),e.getDate()+x));return new Set([...fixed,iso(1),iso(60)])}

/* losowe wolne 18–25% z antyklastrem */
function applyRandomOff(list){
  const idx=list.map((d,i)=>d.isWorkingDay?i:-1).filter(i=>i>=0);
  if(!idx.length) return;
  let pct=0.18+Math.random()*0.07, toDrop=Math.max(1,Math.round(idx.length*pct));
  const byW=new Map(); idx.forEach(i=>{const w=Math.floor((list[i].day-1)/7); if(!byW.has(w)) byW.set(w,[]); byW.get(w).push(i);});
  const picks=new Set();
  for(const w of byW.keys()){ if(toDrop===0) break; const pool=byW.get(w); picks.add(pool[Math.floor(Math.random()*pool.length)]); toDrop--; }
  const can=idx.filter(i=>!picks.has(i)); for(let i=can.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[can[i],can[j]]=[can[j],can[i]];}
  const far=i=>{for(const p of picks){ if(Math.abs(p-i)<=1) return false;} return true;}
  for(const i of can){ if(toDrop===0) break; if(far(i)){ picks.add(i); toDrop--; } }
  for(const i of can){ if(toDrop===0) break; if(!picks.has(i)){ picks.add(i); toDrop--; } }
  for(const i of picks){ list[i].isWorkingDay=false; list[i].holidayType="-"; }
}

/* rozkład godzin */
function weightedHours(min,max,variance){
  const buckets = variance
    ? [{lo:Math.max(min,6),hi:Math.min(max,8),w:5},{lo:Math.max(min,9),hi:Math.min(max,12),w:7},{lo:Math.max(min,13),hi:Math.min(max,16),w:2}]
    : [{lo:Math.max(min,4),hi:Math.min(max,6),w:3},{lo:Math.max(min,7),hi:Math.min(max,9),w:6},{lo:Math.max(min,10),hi:Math.min(max,12),w:3},{lo:Math.max(min,13),hi:Math.min(max,16),w:1}];
  const u=buckets.filter(b=>b.lo<=b.hi), tot=u.reduce((a,b)=>a+b.w,0);
  let r=Math.random()*tot,p=u[0]; for(const b of u){ r-=b.w; if(r<=0){p=b;break;} }
  return ri(p.lo,p.hi);
}
function distribute(total,n,min,max,variance){
  if(n===0) return total===0?[]:null;
  const minAll=min*n,maxAll=max*n;
  if(total<minAll){alert(`Za mało godzin (min. ${minAll}).`);return null;}
  if(total>maxAll){alert(`Za dużo godzin (max. ${maxAll}).`);return null;}
  let arr=Array.from({length:n},()=>weightedHours(min,max,variance)), sum=arr.reduce((a,b)=>a+b,0);
  const inc=()=>{const id=arr.map((v,i)=>[v,i]).filter(([v])=>v<max).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); if(!id.length) return false; arr[id[ri(0,Math.min(3,id.length-1))]]++; return true;};
  const dec=()=>{const id=arr.map((v,i)=>[v,i]).filter(([v])=>v>min).sort((a,b)=>b[0]-a[0]).map(x=>x[1]); if(!id.length) return false; arr[id[ri(0,Math.min(3,id.length-1))]]--; return true;};
  while(sum<total&&inc()) sum++; while(sum>total&&dec()) sum--;
  for(let i=1;i<n;i++){ if(arr[i]===arr[i-1]){ if(arr[i]<max){arr[i]++;sum++;} else if(arr[i-1]>min){arr[i-1]--;sum--;} } }
  while(sum<total&&inc()) sum++; while(sum>total&&dec()) sum--;
  for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
  return arr;
}

/* dystrybucja końców: 20:00 maks 25% */
function sampleEndDistribution(n){
  const counts={
    early: Math.max(1, Math.round(n*0.25)), // 14–16
    mid:   Math.max(1, Math.round(n*0.40)), // 16–18
    late:  Math.max(1, Math.round(n*0.20)), // 18–19
    cap20: Math.max(0, Math.round(n*0.15))  // 20
  };
  let pool=[];
  for(let i=0;i<counts.early;i++) pool.push(ri(14,16));
  for(let i=0;i<counts.mid;i++)   pool.push(ri(16,18));
  for(let i=0;i<counts.late;i++)  pool.push(ri(18,19));
  for(let i=0;i<counts.cap20;i++) pool.push(20);
  while(pool.length<n) pool.push(ri(16,19));
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  return pool.slice(0,n);
}

/* przypisywanie okien 6–20 */
function clampStartForHours(s,h){
  const sMin=MIN_START, sMax=MAX_END-h;
  return clamp(s, sMin, sMax);
}
function assignTimes(days,hoursArr){
  const n=days.length;
  let targetEnds=sampleEndDistribution(n);
  let prevStart=null, prevEnd=null;

  for(let i=0;i<n;i++){
    const h = hoursArr[i];
    let E  = targetEnds[i];
    E = clamp(E, MIN_START+h, MAX_END);
    let sMin = MIN_START, sMax = MAX_END - h;
    let s = clamp(E - h + ri(-1,1), sMin, sMax);
    let e = s + h;

    if(prevStart!==null && prevEnd!==null){
      if(s===prevStart && e===prevEnd){
        if(e<MAX_END){ s = clampStartForHours(s+1,h); e = s + h; }
        else if(s>MIN_START){ s = clampStartForHours(s-1,h); e = s + h; }
      }else if(s===prevStart){
        const try1 = clampStartForHours(s+(Math.random()<0.5?-1:1),h);
        s=try1; e=s+h;
      }else if(e===prevEnd){
        if(e<MAX_END){ s = clampStartForHours(s+1,h); e=s+h; }
        else if(s>MIN_START){ s = clampStartForHours(s-1,h); e=s+h; }
      }
    }

    if(Math.random()<0.3){
      const dir = Math.random()<0.5 ? -1 : 1;
      const ns = clampStartForHours(s+dir,h);
      s=ns; e=s+h;
    }

    s = clampStartForHours(s,h);
    e = s + h;

    days[i].hours=h;
    days[i].start=(s<10?`0${s}`:s)+":00";
    days[i].end=(e<10?`0${e}`:e)+":00";
    prevStart=s; prevEnd=e;
  }

  const ends20 = [];
  for(let i=0;i<n;i++) if(days[i].end==="20:00") ends20.push(i);
  const max20 = Math.ceil(n*0.25);
  if(ends20.length>max20){
    const over=ends20.length-max20;
    for(let k=0;k<over;k++){
      const i=ends20[k];
      let s = parseInt(days[i].start,10), h = days[i].hours;
      s = clampStartForHours(s-1,h);
      days[i].start=(s<10?`0${s}`:s)+":00";
      days[i].end=((s+h)<10?`0${s+h}`:(s+h))+":00";
    }
  }
}

/* UI */
function updateRanges(){
  const m=+document.getElementById("month").value||0, y=+document.getElementById("year").value||0;
  const pick=document.getElementById("holidayPicker");
  if(!m||!y){ pick.removeAttribute("min"); pick.removeAttribute("max"); return; }
  const days=new Date(y,m,0).getDate(), mm=String(m).padStart(2,'0');
  pick.min=`${y}-${mm}-01`; pick.max=`${y}-${mm}-${String(days).padStart(2,'0')}`;
}
function renderHolidays(){
  const ul=document.getElementById("holidaysList"); ul.innerHTML="";
  customHolidays.sort((a,b)=>a.date.localeCompare(b.date));
  for(const item of customHolidays){
    const li=document.createElement("li");
    li.textContent = `${item.date} – ${item.type}`;
    const btn=document.createElement("button");
    btn.className="btn btn-sm btn-outline-danger ms-2"; btn.textContent="Usuń";
    btn.onclick=()=>{ customHolidays=customHolidays.filter(x=>x!==item); renderHolidays(); };
    li.appendChild(btn); ul.appendChild(li);
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("addHoliday").addEventListener("click", ()=>{
    const d=document.getElementById("holidayPicker").value;
    const t=document.getElementById("holidayTypeSelect").value;
    if(!d){ alert("Wybierz datę."); return; }
    if(!customHolidays.find(x=>x.date===d)){ customHolidays.push({date:d,type:t}); }
    else{ alert("Ta data już jest dodana."); }
    renderHolidays();
  });
  document.getElementById("month").addEventListener("change", updateRanges);
  document.getElementById("year").addEventListener("change", updateRanges);
  updateRanges();

  document.getElementById("generatorForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    generate();
  });
  document.getElementById("generatePDF").addEventListener("click", downloadPDF);
  document.getElementById("sendMail").addEventListener("click", sendPDFMail);
});

function generate(){
  const name=document.getElementById("name").value.trim();
  const m=+document.getElementById("month").value;
  const y=+document.getElementById("year").value;
  const type=document.querySelector('input[name="contractType"]:checked').value;
  const rand=document.getElementById("randomHolidays").checked;
  const total=+document.getElementById("hours").value||0;
  if(!name||!m||!y){ alert("Uzupełnij dane."); return; }
  if(type==="zlecenie" && total<30){ alert("Minimalnie 30 godzin."); return; }

  const daysInMonth=new Date(y,m,0).getDate();
  const hset=plHolidays(y);

  let dayData=[];
  for(let d=1; d<=daysInMonth; d++){
    const dt=new Date(y,m-1,d);
    const iso=toISO(dt);
    const weekend=isWeekend(dt);
    const publicH=hset.has(iso);
    const custom=customHolidays.find(x=>x.date===iso);
    const isWork = (!weekend && !publicH && !custom);
    const hol = publicH ? "Święto" : (custom ? custom.type : "");
    dayData.push({day:d,date:dt,isWorkingDay:isWork,holidayType:hol,hours:0,start:"-",end:"-"});
  }

  if(type==="zlecenie" && rand){ applyRandomOff(dayData); }

  let working=dayData.filter(x=>x.isWorkingDay);

  if(type==="praca"){
    working.forEach(d=>{ d.hours=8; d.start="08:00"; d.end="16:00"; });
  }else if(type==="praca3/4"){
    working.forEach(d=>{ d.hours=6; d.start="08:00"; d.end="14:00"; });
  }else{ // zlecenie
    const variance = rand===true;
    const arr = distribute(total, working.length, MIN_H, MAX_H, variance);
    if(!arr) return;
    assignTimes(working, arr); // 6–20 po klamrach
  }

  document.getElementById("mname").textContent = `${monthNames[m-1]} ${y}`;
  document.getElementById("pname").textContent = name;
  document.getElementById("ctype").textContent =
    type==="praca" ? "Umowa o pracę" : type==="praca3/4" ? "Umowa o pracę (3/4)" : "Umowa zlecenie";

  const last = name.split(/\s+/).slice(1).join(" ") || name;

  const rows = dayData.map(inf=>{
    const dd=String(inf.day).padStart(2,'0'), mm=String(m).padStart(2,'0'), yyyy=y;
    const wkd=inf.date.toLocaleString('pl-PL',{weekday:'short'});
    if(inf.isWorkingDay){
      return `<tr>
        <td class="mono">${inf.day}</td>
        <td class="col-date">${dd}.${mm}.${yyyy} (${wkd})</td>
        <td class="mono">${inf.start}</td>
        <td class="mono">${inf.end}</td>
        <td class="mono">${inf.hours}</td>
        <td>${last}</td>
        <td></td>
        <td>-</td>
      </tr>`;
    }
    const shown = (inf.holidayType==="Święto") ? "Święto" : "-";
    return `<tr class="off">
      <td class="mono">${inf.day}</td>
      <td class="col-date">${dd}.${mm}.${yyyy} (${wkd})</td>
      <td class="mono">-</td>
      <td class="mono">-</td>
      <td class="mono">0</td>
      <td>${last}</td>
      <td></td>
      <td>${shown}</td>
    </tr>`;
  });

  const sum=dayData.filter(d=>d.isWorkingDay).reduce((a,b)=>a+b.hours,0);
  const table=`
  <table class="table-times">
    <thead>
      <tr>
        <th class="col-day">Dzień</th>
        <th>Data</th>
        <th class="col-start">Godz. rozpoczęcia</th>
        <th class="col-end">Godz. zakończenia</th>
        <th class="col-hours">Suma godzin</th>
        <th class="col-sign">Podpis zleceniobiorcy</th>
        <th class="col-sign">Podpis zleceniodawcy</th>
        <th class="col-leave">Urlop</th>
      </tr>
    </thead>
    <tbody>${rows.join("")}</tbody>
    <tfoot><tr><td colspan="4">Suma</td><td class="mono">${sum}</td><td colspan="3"></td></tr></tfoot>
  </table>`;
  document.getElementById("output").innerHTML=table;
  document.getElementById("resultWrap").style.display='block';
  document.getElementById("generatePDF").disabled=false;
  document.getElementById("sendMail").disabled=false;
}

async function renderToPDFBase64(){
  const jsPDF=window.jspdf.jsPDF;
  const pdf=new jsPDF("portrait","pt","a4");
  const out=document.getElementById("resultWrap");
  const canvas=await html2canvas(out,{scale:1.6,useCORS:true,backgroundColor:"#ffffff"});
  const pageW=pdf.internal.pageSize.getWidth();
  const w=pageW-40, h=canvas.height*(w/canvas.width);
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",20,20,w,h);
  return btoa(pdf.output("arraybuffer"));
}

async function downloadPDF(){
  try{
    const base64 = await renderToPDFBase64();
    const a=document.createElement("a");
    a.href="data:application/pdf;base64,"+base64;
    a.download="Tabela_Godzinowa.pdf";
    a.click();
  }catch(e){console.error(e);alert("Nie udało się wygenerować PDF.");}
}

async function sendPDFMail(){
  try{
    const name=document.getElementById("name").value.trim();
    if(!name){ alert("Uzupełnij imię i nazwisko."); return; }
    const base64 = await renderToPDFBase64();
    const res = await fetch("/send-pdf",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ name, pdfData: base64 })
    });
    const data = await res.json();
    if(data && data.ok) alert("Wysłano PDF na maila.");
    else alert("Błąd wysyłki: "+(data?.error||""));
  }catch(e){ console.error(e); alert("Błąd połączenia z serwerem."); }
}
})();
</script>
</body>
</html>

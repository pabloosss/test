<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<title>Wnioski – kalendarz i tabela godzin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<style>
:root{--ink:#111;--muted:#555;--grid:#000;--off-bg:#ffcccc;--off-ink:#a00;--thead:#fafafa;--paper:#fff;--sel:#2563eb22;--sel-br:#2563eb}
html,body{background:#f5f7fb;color:var(--ink)}
.container{max-width:1100px}
header{background:#fff;border-bottom:1px solid #e5e7eb}
.brand{font-weight:700}
.card{border:1px solid #e5e7eb;border-radius:12px}
.card-header{background:#fff;border-bottom:1px solid #e5e7eb;font-weight:600}

/* kalendarz */
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal .dow{font-size:12px;color:#666;text-align:center}
.cal .day{background:#fff;border:1px solid #e5e7eb;border-radius:10px;min-height:90px;padding:8px;cursor:pointer;user-select:none;position:relative}
.cal .day.off{background:var(--off-bg);color:var(--off-ink);border-color:#a00}
.cal .day.sel{outline:2px solid var(--sel-br);background:var(--sel)}
.cal .day .num{font-weight:800}
.cal .day .badge{position:absolute;right:6px;bottom:6px;font-size:10px}
.cal .day.dim{opacity:.45}
.cal-wrap{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}

/* arkusz */
.sheet-wrap{background:var(--paper);border:1px solid var(--grid);border-radius:10px;overflow:hidden}
.sheet-head{padding:16px 18px 8px 18px;border-bottom:1px solid var(--grid)}
.sheet-head .mname{font-size:22px;font-weight:800;margin:0}
.sheet-head .person{font-size:16px;font-weight:700;margin:2px 0 0}
.sheet-head .ctype{font-size:12px;color:var(--muted);margin:0}

/* tabela */
.table-times{width:100%;border-collapse:collapse;table-layout:fixed;background:var(--paper)}
.table-times th,.table-times td{border:1px solid var(--grid);padding:8px 10px;text-align:center;vertical-align:middle;background:#fff;font-size:14px}
.table-times thead th{background:var(--thead);font-weight:700}
.table-times .col-day{width:56px}
.table-times .col-date{text-align:left}
.table-times .col-start,.table-times .col-end{width:100px}
.table-times .col-hours{width:92px}
.table-times .col-sign{width:160px}
.table-times .col-leave{width:110px}
.mono{font-variant-numeric:tabular-nums}
.table-times tr.off td{background:var(--off-bg);color:var(--off-ink);font-weight:700}
.table-times tfoot td{font-weight:800;background:#fff}

@media print{
  body{background:#fff}
  .card,.sheet-wrap{box-shadow:none}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
</style>
</head>
<body>
<header>
  <div class="container py-3 d-flex justify-content-between align-items-center">
    <div class="brand h5 m-0"><i class="fas fa-calendar-check me-2 text-primary"></i>Wnioski – wybór dni i tabela</div>
    <a class="btn btn-outline-secondary btn-sm" href="./index.html"><i class="fa fa-arrow-left me-1"></i>Powrót</a>
  </div>
</header>

<main class="container py-4">
  <section class="card mb-4">
    <div class="card-header py-3 px-4">Parametry</div>
    <div class="card-body p-4">
      <form id="form" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Imię i nazwisko *</label>
          <input id="name" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Rok *</label>
          <input id="year" type="number" min="2000" value="2025" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Miesiąc *</label>
          <select id="month" class="form-select" required>
            <option value="">Wybierz…</option>
            <option value="1">Styczeń</option><option value="2">Luty</option><option value="3">Marzec</option>
            <option value="4">Kwiecień</option><option value="5">Maj</option><option value="6">Czerwiec</option>
            <option value="7">Lipiec</option><option value="8">Sierpień</option><option value="9">Wrzesień</option>
            <option value="10">Październik</option><option value="11">Listopad</option><option value="12">Grudzień</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label d-block">Szybki wybór</label>
          <div class="btn-group w-100">
            <button id="selectWorkdays" type="button" class="btn btn-outline-secondary btn-sm">Pon–Pt</button>
            <button id="clearAll" type="button" class="btn btn-outline-secondary btn-sm">Wyczyść</button>
          </div>
        </div>

        <div class="col-12">
          <div class="cal-wrap">
            <div class="d-flex align-items-center gap-3 flex-wrap mb-2">
              <span class="text-muted small">Kliknij dni, aby zaznaczyć obecność. Miesiąc może być niepełny.</span>
              <span class="badge border bg-light">Zielona ramka = obecność</span>
              <span class="badge" style="background:#ffcccc;border:1px solid #a00;color:#a00">Czerwone = weekend/święto</span>
            </div>
            <div id="calendar" class="cal"></div>
          </div>
        </div>

        <!-- Tryb wyboru -->
        <div class="col-12">
          <label class="form-label d-block">Tryb czasu pracy</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="mode" id="modeFixed" value="fixed" checked>
            <label class="form-check-label" for="modeFixed">Stałe godziny każdego dnia</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="mode" id="modeTotal" value="total">
            <label class="form-check-label" for="modeTotal">Łączna liczba godzin (losowy podział)</label>
          </div>
        </div>

        <!-- Pola dla trybu "fixed" -->
        <div class="col-md-3 mode-fixed">
          <label class="form-label">Godz. start</label>
          <input id="startTime" type="time" value="08:00" class="form-control">
        </div>
        <div class="col-md-3 mode-fixed">
          <label class="form-label">Godz. koniec</label>
          <input id="endTime" type="time" value="16:00" class="form-control">
        </div>

        <!-- Pola dla trybu "total" -->
        <div class="col-md-3 mode-total" style="display:none;">
          <label class="form-label">Łączna liczba godzin *</label>
          <input id="totalHours" type="number" min="1" class="form-control" placeholder="np. 120">
          <div class="form-text">Rozdział 4–16 h/dzień, w oknie 06–20.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Uwagi (opcjonalnie)</label>
          <input id="note" class="form-control" placeholder="np. Wniosek o pracę w wybrane dni">
        </div>

        <div class="col-12 d-flex gap-2">
          <button id="genTable" type="button" class="btn btn-primary"><i class="fa fa-table me-1"></i>Generuj tabelę</button>
          <button id="downloadPDF" type="button" class="btn btn-success" disabled><i class="fa-regular fa-file-pdf me-1"></i>Pobierz PDF</button>
        </div>
      </form>
    </div>
  </section>

  <section class="sheet-wrap" id="resultWrap" style="display:none;">
    <div class="sheet-head">
      <h2 class="mname" id="mname"></h2>
      <p class="person" id="pname"></p>
      <p class="ctype" id="ctype"></p>
    </div>
    <div id="output"></div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(()=>{"use strict";
const MIN_START=6, MAX_END=20;
const MIN_H=4, MAX_H=16;
const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
const cal=document.getElementById("calendar");
let selected=new Set(); /* ISO yyyy-mm-dd */

/* święta PL */
function easterSunday(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),mo=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,mo-1,day);}
function plHolidays(y){const fixed=["01-01","01-06","05-01","05-03","08-15","11-01","11-11","12-25","12-26"].map(md=>`${y}-${md}`);const e=easterSunday(y);const iso=x=>toISO(new Date(e.getFullYear(),e.getMonth(),e.getDate()+x));return new Set([...fixed,iso(1),iso(60)])}
const toISO=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const isWeekend=d=>{const w=d.getDay();return w===0||w===6;}

/* kalendarz */
function renderCalendar(m,y){
  cal.innerHTML="";
  const heads=["Pn","Wt","Śr","Cz","Pt","So","Nd"];
  heads.forEach(h=>{const e=document.createElement("div");e.className="dow";e.textContent=h;cal.appendChild(e);});

  const holidays=plHolidays(y);
  const first=new Date(y,m-1,1);
  const startCol=(first.getDay()+6)%7; // pn=0
  const daysIn=new Date(y,m,0).getDate();
  const prevDays=new Date(y,m-1,0).getDate();

  for(let i=0;i<startCol;i++){
    const dt=new Date(y,m-2, prevDays-startCol+i+1);
    cal.appendChild(dayCell(dt,true,holidays));
  }
  for(let d=1;d<=daysIn;d++){
    const dt=new Date(y,m-1,d);
    cal.appendChild(dayCell(dt,false,holidays));
  }
  const totalCells=7*6;
  const used=7+startCol+daysIn;
  for(let i=0;i<totalCells-used;i++){
    const dt=new Date(y,m, i+1);
    cal.appendChild(dayCell(dt,true,holidays));
  }
}
function dayCell(dt,dim,holidays){
  const iso=toISO(dt);
  const div=document.createElement("div");
  div.className="day"+(dim?" dim":"");
  const weekend=isWeekend(dt);
  const publicH=holidays.has(iso);
  if(weekend||publicH) div.classList.add("off");
  if(selected.has(iso)) div.classList.add("sel");
  div.dataset.iso=iso;
  div.innerHTML=`<div class="num">${dt.getDate()}</div>${publicH?`<span class="badge text-bg-danger">Święto</span>`:""}`;
  div.addEventListener("click", ()=>{
    if(dim) return;
    if(selected.has(iso)) selected.delete(iso); else selected.add(iso);
    div.classList.toggle("sel");
  });
  return div;
}

/* losowanie godzin dla trybu łącznej sumy */
const ri=(a,b)=>{a=Math.ceil(a);b=Math.floor(b);return Math.floor(Math.random()*(b-a+1))+a;}
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const clampStartForHours=(s,h)=>clamp(s,MIN_START,MAX_END-h);

function sampleEndDistribution(n){
  const counts={early:Math.max(1,Math.round(n*0.25)),mid:Math.max(1,Math.round(n*0.40)),late:Math.max(1,Math.round(n*0.20)),cap20:Math.max(0,Math.round(n*0.15))};
  let pool=[];
  for(let i=0;i<counts.early;i++) pool.push(ri(14,16));
  for(let i=0;i<counts.mid;i++)   pool.push(ri(16,18));
  for(let i=0;i<counts.late;i++)  pool.push(ri(18,19));
  for(let i=0;i<counts.cap20;i++) pool.push(20);
  while(pool.length<n) pool.push(ri(16,19));
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  return pool.slice(0,n);
}
function weightedHours(min,max){
  const buckets=[{lo:6,hi:8,w:5},{lo:9,hi:12,w:7},{lo:13,hi:16,w:2}]
    .map(b=>({lo:Math.max(min,b.lo),hi:Math.min(max,b.hi),w:b.w})).filter(b=>b.lo<=b.hi);
  const tot=buckets.reduce((a,b)=>a+b.w,0);
  let r=Math.random()*tot, pick=buckets[0];
  for(const b of buckets){ r-=b.w; if(r<=0){pick=b;break;} }
  return ri(pick.lo,pick.hi);
}
function distribute(total,n,min,max){
  if(n===0) return total===0?[]:null;
  const minAll=min*n,maxAll=max*n;
  if(total<minAll||total>maxAll) return null;
  let arr=Array.from({length:n},()=>weightedHours(min,max)), sum=arr.reduce((a,b)=>a+b,0);
  const inc=()=>{const idx=arr.map((v,i)=>[v,i]).filter(([v])=>v<max).map(x=>x[1]); if(!idx.length) return false; arr[idx[Math.floor(Math.random()*idx.length)]]++; return true;};
  const dec=()=>{const idx=arr.map((v,i)=>[v,i]).filter(([v])=>v>min).map(x=>x[1]); if(!idx.length) return false; arr[idx[Math.floor(Math.random()*idx.length)]]--; return true;};
  while(sum<total&&inc()) sum++; while(sum>total&&dec()) sum--;
  for(let i=1;i<n;i++){ if(arr[i]===arr[i-1]){ if(arr[i]<max){arr[i]++;sum++;} else if(arr[i-1]>min){arr[i-1]--;sum--;} } }
  while(sum<total&&inc()) sum++; while(sum>total&&dec()) sum--;
  for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
  return arr;
}
function assignTimesForTotal(days,hoursArr){
  const n=days.length, out=new Map();
  let ends=sampleEndDistribution(n), prevS=null, prevE=null;
  for(let i=0;i<n;i++){
    const h=hoursArr[i];
    let E=clamp(ends[i], MIN_START+h, MAX_END);
    let s=clampStartForHours(E-h + ri(-1,1), h);
    let e=s+h;
    if(prevS!==null && prevE!==null){
      if(s===prevS && e===prevE){
        if(e<MAX_END){ s=clampStartForHours(s+1,h); e=s+h; }
        else if(s>MIN_START){ s=clampStartForHours(s-1,h); e=s+h; }
      }else if(s===prevS){
        s=clampStartForHours(s+(Math.random()<0.5?-1:1),h); e=s+h;
      }else if(e===prevE){
        if(e<MAX_END){ s=clampStartForHours(s+1,h); e=s+h; }
        else if(s>MIN_START){ s=clampStartForHours(s-1,h); e=s+h; }
      }
    }
    if(Math.random()<0.3){ s=clampStartForHours(s+(Math.random()<0.5?-1:1),h); e=s+h; }
    const iso=toISO(days[i]);
    out.set(iso,{start:(s<10?`0${s}`:s)+":00", end:((e)<10?`0${e}`:e)+":00", hours:h});
    prevS=s; prevE=e;
  }
  const keys=[...out.keys()];
  const ends20=keys.filter(k=>out.get(k).end==="20:00");
  const max20=Math.ceil(n*0.25);
  if(ends20.length>max20){
    for(let k=0;k<ends20.length-max20;k++){
      const key=ends20[k]; let {start,hours:h}=out.get(key); let s=parseInt(start,10);
      s=clampStartForHours(s-1,h);
      out.set(key,{start:(s<10?`0${s}`:s)+":00", end:((s+h)<10?`0${s+h}`:(s+h))+":00", hours:h});
    }
  }
  return out;
}

/* UI */
function init(){
  document.getElementById("genTable").addEventListener("click", generateTable);
  document.getElementById("downloadPDF").addEventListener("click", downloadPDF);
  document.getElementById("selectWorkdays").addEventListener("click", ()=>{
    const y=+document.getElementById("year").value, m=+document.getElementById("month").value;
    const daysIn=new Date(y,m,0).getDate();
    for(let d=1; d<=daysIn; d++){
      const dt=new Date(y,m-1,d);
      if(!isWeekend(dt)) selected.add(toISO(dt));
    }
    renderCalendar(m,y);
  });
  document.getElementById("clearAll").addEventListener("click", ()=>{
    selected.clear();
    renderCalendar(+document.getElementById("month").value, +document.getElementById("year").value);
  });

  const yI=document.getElementById("year");
  const mI=document.getElementById("month");
  const now=new Date();
  yI.value = now.getFullYear();
  mI.value = String(now.getMonth()+1);
  renderCalendar(+mI.value, +yI.value);
  yI.addEventListener("change", ()=>renderCalendar(+mI.value, +yI.value));
  mI.addEventListener("change", ()=>renderCalendar(+mI.value, +yI.value));

  /* przełączanie trybu */
  const setMode=()=>{
    const fixed = document.getElementById("modeFixed").checked;
    for(const el of document.querySelectorAll(".mode-fixed")) el.style.display = fixed ? "" : "none";
    for(const el of document.querySelectorAll(".mode-total")) el.style.display = fixed ? "none" : "";
  };
  document.getElementById("modeFixed").addEventListener("change", setMode);
  document.getElementById("modeTotal").addEventListener("change", setMode);
  setMode();
}
document.addEventListener("DOMContentLoaded", init);

/* tabela + PDF */
function generateTable(){
  const name=document.getElementById("name").value.trim();
  const m=+document.getElementById("month").value;
  const y=+document.getElementById("year").value;
  const note=document.getElementById("note").value.trim();
  const mode = document.getElementById("modeFixed").checked ? "fixed" : "total";
  if(!name||!m||!y){ alert("Uzupełnij imię, miesiąc i rok."); return; }

  const daysIn=new Date(y,m,0).getDate();
  const holidays=plHolidays(y);
  const monthISO = (d)=>d.startsWith(`${y}-${String(m).padStart(2,'0')}-`);
  const chosen = Array.from(selected).filter(monthISO).map(iso=>new Date(iso)).sort((a,b)=>a-b);

  if(chosen.length===0){ alert("Zaznacz co najmniej jeden dzień w kalendarzu."); return; }

  let workMap=new Map(); // iso -> {start,end,hours}
  if(mode==="fixed"){
    const s=document.getElementById("startTime").value || "08:00";
    const e=document.getElementById("endTime").value || "16:00";
    const toMin=t=>{const [hh,mm]=t.split(":").map(Number);return hh*60+mm;}
    const mins=Math.max(0, toMin(e)-toMin(s));
    const hours=(mins/60);
    if(hours<=0){ alert("Godziny start/koniec są nieprawidłowe."); return; }
    /* przypisz tylko dni robocze */
    chosen.forEach(dt=>{
      const iso=toISO(dt);
      if(isWeekend(dt)||holidays.has(iso)) return;
      workMap.set(iso,{start:s,end:e,hours:hours});
    });
  }else{
    const total=+document.getElementById("totalHours").value||0;
    if(total<=0){ alert("Podaj łączną liczbę godzin."); return; }
    const workingDays = chosen.filter(dt=>!isWeekend(dt)&&!holidays.has(toISO(dt)));
    const n=workingDays.length;
    if(n===0){ alert("Brak wybranych dni roboczych do rozdzielenia godzin."); return; }
    const arr=distribute(total,n,MIN_H,MAX_H);
    if(!arr){ alert(`Nie da się rozdzielić ${total} h na ${n} dni w granicach ${MIN_H}–${MAX_H} h.`); return; }
    const times=assignTimesForTotal(workingDays, arr);
    workMap=times;
  }

  const last = name.split(/\s+/).slice(1).join(" ") || name;
  const rows=[];
  let sum=0;
  const weekdays=["nd","pn","wt","śr","cz","pt","so"];

  for(let d=1; d<=daysIn; d++){
    const dt=new Date(y,m-1,d);
    const iso=toISO(dt);
    const dd=String(d).padStart(2,'0'), mm=String(m).padStart(2,'0');
    const w=weekdays[dt.getDay()];
    const weekend=isWeekend(dt);
    const pub=holidays.has(iso);
    const chosenDay=selected.has(iso);

    const work=workMap.get(iso);
    if(work){
      sum+=work.hours;
      rows.push(`<tr>
        <td class="mono">${d}</td>
        <td class="col-date">${dd}.${mm}.${y} (${w})</td>
        <td class="mono">${work.start}</td><td class="mono">${work.end}</td>
        <td class="mono">${work.hours}</td>
        <td>${last}</td><td></td><td>-</td>
      </tr>`);
    }else{
      rows.push(`<tr class="off">
        <td class="mono">${d}</td>
        <td class="col-date">${dd}.${mm}.${y} (${w})</td>
        <td class="mono">-</td><td class="mono">-</td>
        <td class="mono">0</td>
        <td>${last}</td><td></td><td>${pub?"Święto":"-"}</td>
      </tr>`);
    }
  }

  document.getElementById("mname").textContent = `${monthNames[m-1]} ${y}`;
  document.getElementById("pname").textContent = name + (note?` — ${note}`:"");
  document.getElementById("ctype").textContent = (mode==="fixed")
    ? "Wniosek – wybrane dni (stałe godziny)"
    : "Wniosek – wybrane dni (łączna liczba godzin)";

  const table=`
  <table class="table-times">
    <thead>
      <tr>
        <th class="col-day">Dzień</th>
        <th>Data</th>
        <th class="col-start">Godz. rozpoczęcia</th>
        <th class="col-end">Godz. zakończenia</th>
        <th class="col-hours">Suma godzin</th>
        <th class="col-sign">Podpis zleceniobiorcy</th>
        <th class="col-sign">Podpis zleceniodawcy</th>
        <th class="col-leave">Urlop</th>
      </tr>
    </thead>
    <tbody>${rows.join("")}</tbody>
    <tfoot><tr><td colspan="4">Suma</td><td class="mono">${sum}</td><td colspan="3"></td></tr></tfoot>
  </table>`;

  document.getElementById("output").innerHTML=table;
  document.getElementById("resultWrap").style.display='block';
  document.getElementById("downloadPDF").disabled=false;
}

async function downloadPDF(){
  const jsPDF=window.jspdf.jsPDF;
  const out=document.getElementById("resultWrap");
  const pdf=new jsPDF("portrait","pt","a4");
  const canvas=await html2canvas(out,{scale:1.6,useCORS:true,backgroundColor:"#ffffff"});
  const pageW=pdf.internal.pageSize.getWidth();
  const w=pageW-40, h=canvas.height*(w/canvas.width);
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",20,20,w,h);
  pdf.save("Wniosek_Wybrane_Dni.pdf");
}
})();
</script>
</body>
</html>
